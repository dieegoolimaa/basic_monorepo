<div class="page-container fade-in">
    <div class="page-header">
        <div>
            <h1 class="page-title">Gerenciar Alunas</h1>
            <p class="page-subtitle">Crie convites e gerencie o acesso aos cursos.</p>
        </div>
        <button nz-button nzType="primary" class="btn-create" (click)="showInviteModal()">
            <span nz-icon nzType="plus"></span> Criar Convite
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon-wrapper">
                <span nz-icon nzType="user"></span>
            </div>
            <div class="stat-info">
                <span class="stat-number">{{ users.length }}</span>
                <span class="stat-label">Alunas Cadastradas</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon-wrapper">
                <span nz-icon nzType="check-circle"></span>
            </div>
            <div class="stat-info">
                <span class="stat-number">{{ getActiveUsers() }}</span>
                <span class="stat-label">Alunas Ativas</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon-wrapper">
                <span nz-icon nzType="mail"></span>
            </div>
            <div class="stat-info">
                <span class="stat-number">{{ inviteCodes.length }}</span>
                <span class="stat-label">Convites Pendentes</span>
            </div>
        </div>
    </div>

    <!-- Pending Invites -->
    <div class="section-card" *ngIf="inviteCodes.length > 0">
        <div class="section-header-row">
            <h3 class="section-heading">
                <span nz-icon nzType="clock-circle"></span>
                Convites Aguardando Cadastro
            </h3>
        </div>

        <div class="invite-list">
            <div *ngFor="let invite of inviteCodes" class="invite-card">
                <div class="invite-avatar">
                    <span nz-icon nzType="mail"></span>
                </div>
                <div class="invite-info">
                    <span class="invite-email">{{ invite.email }}</span>
                    <div class="invite-meta">
                        <span class="invite-code">
                            <span nz-icon nzType="key"></span> {{ invite.code }}
                        </span>
                        <span class="invite-date">Enviado em {{ invite.createdAt | date:'dd/MM/yyyy' }}</span>
                    </div>
                    <div class="invite-courses">
                        <span nz-icon nzType="book"></span>
                        {{ getCourseNames(invite.courseIds) }}
                    </div>
                </div>
                <div class="invite-actions">
                    <button nz-button nzType="default" nzSize="small" (click)="resendInvite(invite)" nz-tooltip
                        nzTooltipTitle="Reenviar email">
                        <span nz-icon nzType="redo"></span>
                    </button>
                    <button nz-button nzType="default" nzSize="small" (click)="copyCode(invite.code)" nz-tooltip
                        nzTooltipTitle="Copiar código">
                        <span nz-icon nzType="copy"></span>
                    </button>
                    <button nz-button nzType="text" nzDanger nzSize="small" (click)="deleteInvite(invite.code)"
                        nz-tooltip nzTooltipTitle="Cancelar convite">
                        <span nz-icon nzType="delete"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="section-card">
        <div class="section-header-row">
            <h3 class="section-heading">
                <span nz-icon nzType="team"></span>
                Alunas Cadastradas
            </h3>
        </div>

        <div *ngIf="users.length === 0" class="empty-state">
            <div class="empty-icon-wrapper">
                <span nz-icon nzType="user-add" class="empty-icon"></span>
            </div>
            <p class="empty-title">Nenhuma aluna cadastrada</p>
            <p class="empty-hint">Crie um convite para adicionar a primeira aluna.</p>
            <button nz-button nzType="primary" (click)="showInviteModal()">
                <span nz-icon nzType="plus"></span> Criar Convite
            </button>
        </div>

        <div class="users-grid" *ngIf="users.length > 0">
            <div *ngFor="let user of users" class="user-card">
                <div class="user-top">
                    <div class="user-avatar">{{ getInitials(user.name) }}</div>
                    <div class="user-status" [class.active]="user.isActive" [class.inactive]="!user.isActive">
                        {{ user.isActive ? 'Ativa' : 'Inativa' }}
                    </div>
                </div>
                <div class="user-body">
                    <h4 class="user-name">{{ user.name }}</h4>
                    <p class="user-email">{{ user.email }}</p>
                    <p class="user-phone" *ngIf="user.phone">
                        <span nz-icon nzType="phone"></span> {{ user.phone }}
                    </p>
                    <p class="user-location" *ngIf="user.city">
                        <span nz-icon nzType="environment"></span> {{ user.city }}
                    </p>
                    <div class="user-courses">
                        <span class="course-badge">{{ user.enrolledCourses?.length || 0 }} cursos</span>
                    </div>
                </div>
                <div class="user-footer">
                    <button nz-button nzType="text" nzSize="small" (click)="resendPassword(user)" nz-tooltip
                        nzTooltipTitle="Reenviar senha">
                        <span nz-icon nzType="mail"></span>
                    </button>
                    <button nz-button nzType="text" nzSize="small" (click)="editUser(user)" nz-tooltip
                        nzTooltipTitle="Gerenciar cursos">
                        <span nz-icon nzType="edit"></span>
                    </button>
                    <button nz-button nzType="text" nzSize="small" (click)="toggleUserStatus(user)"
                        [nz-tooltip]="user.isActive ? 'Desativar' : 'Ativar'">
                        <span nz-icon [nzType]="user.isActive ? 'stop' : 'check'"
                            [class.text-danger]="user.isActive"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Invite Modal -->
<nz-modal [(nzVisible)]="isInviteModalVisible" nzTitle="Convidar Nova Aluna" [nzFooter]="null"
    (nzOnCancel)="closeInviteModal()" nzWidth="520px" nzCentered>
    <ng-container *nzModalContent>
        <div class="invite-form" *ngIf="!generatedCode">
            <div class="form-intro">
                <p>Insira o email da aluna e selecione os cursos. Um código único será gerado e enviado automaticamente
                    por email com as instruções de cadastro.</p>
            </div>

            <div class="form-group">
                <label>Email da Aluna *</label>
                <input nz-input [(ngModel)]="newInviteEmail" placeholder="email@exemplo.com" type="email"
                    nzSize="large" />
            </div>

            <div class="form-group">
                <label>Cursos Liberados *</label>
                <div class="courses-checklist">
                    <label *ngFor="let course of courses" nz-checkbox [(ngModel)]="courseSelection[course._id]"
                        class="course-checkbox">
                        <div class="course-check-item">
                            <img [src]="course.thumbnailUrl" [alt]="course.title" class="course-thumb"
                                onerror="this.src='https://images.unsplash.com/photo-1604654894610-df63bc536371?w=100'" />
                            <span>{{ course.title }}</span>
                        </div>
                    </label>
                </div>
            </div>

            <button nz-button nzType="primary" nzBlock nzSize="large"
                [disabled]="!newInviteEmail || !hasSelectedCourses()" [nzLoading]="isSending" (click)="createInvite()"
                class="btn-send">
                <span nz-icon nzType="send"></span>
                Enviar Convite por Email
            </button>
        </div>

        <!-- Success State -->
        <div class="invite-success" *ngIf="generatedCode">
            <div class="success-icon">
                <span nz-icon nzType="check-circle" nzTheme="fill"></span>
            </div>
            <h3>Convite Enviado!</h3>
            <p>Um email foi enviado para <strong>{{ newInviteEmail }}</strong> com as instruções de cadastro.</p>

            <div class="code-display">
                <span class="code-label">Código de Acesso:</span>
                <div class="code-value">
                    <span>{{ generatedCode }}</span>
                    <button nz-button nzType="text" (click)="copyCode(generatedCode)">
                        <span nz-icon nzType="copy"></span>
                    </button>
                </div>
            </div>

            <div class="success-actions">
                <button nz-button nzType="default" (click)="createAnother()">
                    <span nz-icon nzType="plus"></span> Criar Outro Convite
                </button>
                <button nz-button nzType="primary" (click)="closeInviteModal()">
                    Concluir
                </button>
            </div>
        </div>
    </ng-container>
</nz-modal>

<!-- Edit User Courses Modal -->
<nz-modal [(nzVisible)]="isEditModalVisible" [nzTitle]="'Gerenciar Cursos - ' + (editingUser?.name || '')"
    [nzFooter]="null" (nzOnCancel)="isEditModalVisible = false" nzWidth="520px" nzCentered>
    <ng-container *nzModalContent>
        <div class="invite-form">
            <div class="form-intro">
                <p>Selecione os cursos que <strong>{{ editingUser?.name }}</strong> terá acesso.</p>
            </div>

            <div class="form-group">
                <div class="courses-checklist">
                    <label *ngFor="let course of courses" nz-checkbox [(ngModel)]="editCourseSelection[course._id]"
                        class="course-checkbox">
                        <div class="course-check-item">
                            <img [src]="course.thumbnailUrl" [alt]="course.title" class="course-thumb"
                                onerror="this.src='https://images.unsplash.com/photo-1604654894610-df63bc536371?w=100'" />
                            <span>{{ course.title }}</span>
                        </div>
                    </label>
                </div>
            </div>

            <button nz-button nzType="primary" nzBlock nzSize="large" (click)="saveUserCourses()">
                Salvar Alterações
            </button>
        </div>
    </ng-container>
</nz-modal>